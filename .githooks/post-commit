#!/usr/bin/env bash
set -euo pipefail

# Best-effort: never block commits.
if [[ -n "${CARAMBA_SKIP_CODEGRAPH_SYNC:-}" ]]; then
  exit 0
fi

ROOT="$(git rev-parse --show-toplevel 2>/dev/null || true)"
if [[ -z "${ROOT}" ]]; then
  exit 0
fi

# Only sync python files changed in this commit.
mapfile -t FILES < <(git diff-tree --no-commit-id --name-only -r HEAD -- '*.py' 2>/dev/null || true)
if [[ ${#FILES[@]} -eq 0 ]]; then
  exit 0
fi

PY="${ROOT}/.venv/bin/python"
if [[ ! -x "${PY}" ]]; then
  PY="python3"
fi

ARGS=()
for f in "${FILES[@]}"; do
  [[ -n "${f}" ]] && ARGS+=(--file "${f}")
done

set +e
"${PY}" -m caramba codegraph-sync "${ROOT}" --best-effort "${ARGS[@]}" >/dev/null 2>&1
exit 0

