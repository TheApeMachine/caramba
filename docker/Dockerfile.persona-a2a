# OPTIMIZED Dockerfile for persona A2A servers
#
# Key optimizations:
# 1. Multi-stage build to separate dependency installation from runtime
# 2. Copy ONLY required code (ai/, console/, config/personas/) - NOT the entire repo
# 3. Install ONLY agent dependencies (no torch, transformers, or ML training code)
# 4. Agents access code via filesystem-mcp tool when needed
#
# Image size: ~200-300MB instead of 2-3GB
# Build time: ~30-60s instead of 5-10 minutes

FROM python:3.12-slim AS base

WORKDIR /app

# System dependencies (minimal)
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install uv (package manager)
ADD https://astral.sh/uv/install.sh /uv-installer.sh
RUN sh /uv-installer.sh && rm /uv-installer.sh && \
    mv /root/.local/bin/uv /usr/local/bin/uv

# ============================================================================
# Stage 1: Install dependencies
# ============================================================================
FROM base AS deps

# Create virtual environment
RUN python3.12 -m venv /opt/venv

# Install ONLY agent dependencies (not the full caramba ML stack)
# This excludes: torch (2GB), transformers (1GB), and all training/inference code
RUN . /opt/venv/bin/activate && uv pip install \
    --no-cache-dir \
    "google-adk[a2a]==1.22.0" \
    "a2a-sdk[postgresql]==0.3.22" \
    "litellm==1.80.11" \
    "pydantic==2.12.5" \
    "pydantic-yaml==1.6.0" \
    "uvicorn==0.40.0" \
    "fastapi==0.123.10" \
    "httpx==0.28.1" \
    "rich==14.2.0" \
    "PyYAML==6.0.3" \
    "networkx==3.6.1" \
    "mcp[cli]==1.25.0" \
    "click==8.3.1" \
    "starlette>=0.37.0" \
    "jsonschema-pydantic==0.6" \
    "asyncpg>=0.29.0" \
    "sqlalchemy[asyncio]>=2.0.0"

# ============================================================================
# Stage 2: Runtime image with minimal code
# ============================================================================
FROM base

# Copy virtual environment from deps stage
COPY --from=deps /opt/venv /opt/venv

ENV VIRTUAL_ENV=/opt/venv
ENV PATH="/opt/venv/bin:${PATH}"
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1
ENV CARAMBA_ROOT=/app

# Copy ONLY the code needed to run agents (NOT the entire repository!)
# Total: ~100-200 files instead of 10,000+

# Create caramba package structure
RUN mkdir -p caramba/ai caramba/console caramba/config config/personas config/teams

# 1. Agent framework (new modular structure)
COPY ai/__init__.py ./caramba/ai/
COPY ai/types.py ./caramba/ai/
COPY ai/persona.py ./caramba/ai/
COPY ai/team.py ./caramba/ai/
COPY ai/agent.py ./caramba/ai/
COPY ai/connection.py ./caramba/ai/
COPY ai/executor.py ./caramba/ai/
COPY ai/retry.py ./caramba/ai/
COPY ai/root.py ./caramba/ai/
COPY ai/lead.py ./caramba/ai/
COPY ai/server.py ./caramba/ai/
COPY ai/entrypoint.py ./caramba/ai/
COPY ai/task_store.py ./caramba/ai/
COPY ai/session_store.py ./caramba/ai/
COPY ai/push_notifications.py ./caramba/ai/

# 2. MCP client/server utilities
COPY ai/mcp/ ./caramba/ai/mcp/

# 3. Extensions (optional utilities)
COPY ai/extensions/ ./caramba/ai/extensions/

# 4. Tools (MCP tool implementations)
COPY ai/tools/ ./caramba/ai/tools/

# 5. Console/logging utilities
COPY console/ ./caramba/console/

# Note: config/personas/ and config/teams/ are mounted from host at runtime
# The volume mount is: ./config:/app/config:ro

# Create package markers (including config module)
RUN touch caramba/__init__.py caramba/config/__init__.py

# Note: config/personas/ is mounted from host at /app/config/personas/
# not /app/caramba/config/personas/, so the PERSONA_FILE env var points to /app/config/personas/*.yml

# Security: non-root user
RUN groupadd -r appuser && \
    useradd -r -g appuser -u 1000 -m -d /home/appuser appuser && \
    chown -R appuser:appuser /app

USER appuser

# Health check (A2A agent card endpoint)
HEALTHCHECK --interval=10s --timeout=5s --start-period=15s --retries=3 \
    CMD curl --fail http://localhost:8001/.well-known/agent-card.json || exit 1

# Run the A2A server via entrypoint
# Environment variables:
#   PERSONA_TYPE: The persona type (e.g., "root", "research_lead", "developer")
#   AGENT_ROLE: "root", "lead", or "worker" (default: "worker")
#   PORT: Port to bind to (default: 8001, root uses 9000)
#   TEAM_CONFIG: Team configuration name (default: "default")
CMD ["python", "-m", "caramba.ai.entrypoint"]
